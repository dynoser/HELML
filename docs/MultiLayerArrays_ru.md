# HELML Многослойность

## HELML (Header-Like Markup Language)

![helml-logo](https://raw.githubusercontent.com/dynoser/HELML/master/logo/icon.png)

Это дополнение к [описанию формата HELML (ru)](https://github.com/dynoser/HELML/blob/master/docs/README-HELML_ru.md)

# Многослойные массивы

Концепция многослойности даёт возможность привязывать значения к разным слоям массива, чтобы при чтении
можно было запрашивать выброку слоёв, значения из которых будут объединены в итоговый массив.

Это удобно когда надо получать массивы с незначительными изменениями, зависящими от параметров чтения.

## Пример: параметры Debug

Допустим, мы создаём файл с описанием настроек для какой-то программы,
и хотим чтобы в режиме отладки некоторые настройки заменялись на другие.
Эти альтернативные варианты настроек можно привязать к отдельному слою, назовём его "dbg".
Далее, при чтении конфигурации будем указывать, накладывать ли слой "dbg" поверх основного слоя.
В результате, запросив наложения слоя "dbg", мы прочитаем массив, в котором поверх основного слоя
будут "наложены" те значения, которые будут взяты из слоя "dbg".

## Пример: многоязычность

Допустим, среди настроек программы есть парамер hello со значением "Hello World!".
Мы хотим, чтобы при использовании русского языка это значение изменялось на "Здравствуй мир!",
а так же хотим чтобы можно было задать это значение для вообще любого языка.
В концепции многослойности мы добавляем это значение к слою, который назовём "ru".
Далее, при чтении массива, будем указывать для наложения слой с именем текущего языка.
В случае русского языка это имя будет "ru", и при чтении массива мы получим массив,
в котором параметр hello будет иметь значение "Здравствуй мир!", потому что значения слоя "ru"
будут наложены поверх основного слоя.

## Пример: множество слоёв

Объединив приведённые выше примеры мы можем дополнительно запросить слои "ru" и "dbg", чтобы получить
на выходе массив, в котором значения будут изменены в соответствии со слоями "ru" и "dbg".

Мы можем задавать сколько угодно слоёв и связывать с ними какие-то параметры.
Затем, когда мы запросим список любых слоёв, мы получем объединение соответствующих параметров.
Если один и тот же параметр будет задан в нескольких слоях, то мы получим самое последнее значение.
Каждое последующее значение заменяет предыдущее, мы всегда получим последнее значение из всех вариантов.

# Реализация многослойность в HELML

Множество слоёв HELML-массива представляются как массивы с одинаковой структурой, но разными значениями.

При запросе любого слоя или комбинации слоёв мы получаем в результате одинаковую структуру вложенности массивов,
однако, значения в них будут результатом объединения значений из всех указанных слоёв.

Если мы запросим не существующие слои, то получим пустую структуру (каркас, в котором не будет значений).

Под существующими слоями мы подразумеваем те слои, с которыми связаны какие-либо значения.

## Особенности реализации

I. Слой `0`.
 - Слой `0` является слоем "по умолчанию".
 - Когда многослойность "не используется", на самом деле используется слой `0`.
 - Когда массив описан без указания слоёв, все его элементы привязаны к слою `0`.
 - При чтении массива без указания слоёв происходит чтение слоя `0`.

II. Имена слоёв
 - Именем слоя может быть либо целое число, либо не-пустая строка.
 - Если имя слоя число, то возможен переход на "следующий слой" при помощи ключа `-+`.
 - Если имя слоя не-число, то использование ключа `-+` будет переходом на "слой по умолчанию".

III. Ключ `-+`
 - Ключ `-+` позволяет временно изменять имя текущего слоя, к которому привязываются значения.
 - Можно после ключа `-+` поставить двоеточие и указать конкретное имя слоя.
 - Можно после ключа `-+` не поставить двоеточие, и:
   - это будет переход на "следующий слой", если имя текущего слоя число
   - это будет возврат на "слой по умолчанию", если имя текущего слоя не число.
 - При изменении уровня вложенности массива имя текущего слоя устанавливается как "слой по умолчанию".
   - В частности, при создании нового уровня вложенности, текущий слой станет "слой по умолчанию".
   - А также, при возврате на предыдущие уровни вложенности, текущий слой станет "слой по умолчанию".

IV. Ключ `-++`
 - Ключ `-++` позволяет установить имя слоя как "слой по умолчанию" и как "текущий слой".
 - Можно после ключа `-++` поставить двоеточие и указать конкретное имя слоя
 - Можно после ключа `-++` не поставить двоеточие, будет означать имя слоя `0`
 - Если после `-++` есть двоеточие и пустое значение, это значит то же самое, что и предыдущий пункт.

V. Значение `[_layers]`
 - Если в описании массива заданы иные слои, кроме `0`, мы получим в массиве результатов дополнительный
ключ `[_layers]`, в котором будет помещён список всех слоёв, упоминаемых в описании массива.
 - Если в описании массива не упоминаются иные слои, ключ [_layers] не будет добавлен результат.
 - Имена слоёв в этом списке всегда скрового типа, даже это числа.

## О различии применения ключей
Ключи `-++` и `-+` предназначены для двух разных практик применения.

Ключ `-++` удобен из-за простоты своей логики: "переключение слоёв всегда делается явно".
Устанавливаем имя слоя, и все дальнейшие значения будут привязываться к нему,
пока мы явно не укажем другой слой. Очень просто, никаких нюансов.

Ключ `-+` предназначен для более тонкого подхода, когда мы используем механизм авто-возврата на
"слой по умолчанию". Кроме того, этот ключ позволяет использовать инкрементальное изменение числовых
имён слоёв. Использование этого ключа требует понимания этих не-очевидных нюансов его работы.

Можно также сказать, что ключ `-++` позволяет изменяет текущий слой "глобально", и дальнейшие значения
будут привязываться к указанному слою до тех пор, пока это не будет явно изменено.
А ключ `-+` позвляет изменять текущий слой "локально", то есть значения будут привязываться к указанному
слою либо до изменения уровня вложенности массива, либо до изменения имени слоя другим ключом.

# Примеры

1. Рассмотрим значение `A[test]`, которое различно в трёх разных слоях:
```console
A
 :test: Слой '0'
 :-+
 :test: Cлой '1'
 :-+
 :test: Слой '2'
 # Создаём под-массив [B]
 :B
   # изменилась вложенность массива, поэтому включился слой "по умолчанию", и это '0'
   ::X: Слой '0'.
```

2. Достигнем подобного результата, что и в предыдущем примере, используя ключ `-++`
```console
A
 # изначально установлен слой '0'
 :test: Слой '0'

 # явно устанавливаем слой '1'
 :-++:1
 :test: Cлой '1', в строке выше явно указано имя слоя
 
 # явно устанавливаем слой '2'
 :-++:2
 :test: Слой '2'
 
 # Создаём под-массив [B]
 :B
   # сбросим имя слоя в '0'. Если этого не сделать, запись будет продолжаться в слой '2'
   ::-++
   # (ключ без значения, что подразумевает установку значения в '0')
   ::X: Слой '0'.
```

В первом примере мы дважды используем ключ "-+" для перехода на "следующий слой".
Поскольку изначально у нас слой 0, то первый переход будет на слой 1, второй на слой 2.
Во втором примере

Теперь если мы прочитаем этот массив с параметрами по умолчанию, то в обоих примерах получим:

```json
{
	"A": {
		"test": "Слой '0'",
		"B": {
			"X": "Слой '0'."
		}
	},
	"_layers": ["0", "1", "2"]
}
```

Как и ожидалось, мы получили значение `A[test]` из слоя '0', поскольку по умолчанию
происходит запрос данных только слоя '0'.

Если мы прочитаем массив, запросив слои 0 и 2, то получим в обоих примерах следующий результат:

```json
{
	"A": {
		"test": "Слой '2'",
		"B": {
			"X": "Слой '0'."
		}
	},
	"_layers": ["0", "1", "2"]
}
```

Как видим, значение `A[test]` мы получаем из слоя '2'.
В значении A[B] мы получаем из слоя '0', поскольку для слоя '2' оно не определено.

Обратим внимание, что в результате появился ключ [_layer], в содержащий список всех слоёв, упомянутых в массиве.

## Пример с выбором языка

```console
    name: Program name
    msg: Press "START"

    -+:ru
    msg: Нажмите "START"

    -+:de
    msg: Drücke "START"

    -+
    hello: Test hello
```

В данном примере декодирование по умолчанию даст такой результат:
```json
{
	"name": "Program name",
	"msg": "Press \"START\"",
	"hello": "Test hello",
	"_layers": [0, "ru", "de"]
}
```

В данном примере обратим внимание на ключ `-+` перед строкой "hello".
Здесь переход на "следующий слой" вернёт слой `0`, поскольку значение "de" не числовое.
Если этого не сделать, то "hello" будет привязано к слою "de".

Ещё раз напомним, что "текущий слой" устанавливается в '0' в следующих случаях:
 - при любом изменении текущего уровня вложенности
 - при явном указании этого слоя: `"-+:0"`
 - при указании `"-+"` без параметров, в том случае, если текущее имя слоя не числовое.

Важно не забывать возвращать запись на слой `0`, если выше был сделан переход на другой слой.