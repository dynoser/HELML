# HELML

## HELML (Header-Like Markup Language)

![helml-logo](https://raw.githubusercontent.com/dynoser/HELML/master/logo/icon.png)

Это дополнение к [описанию формата HELML (ru)](https://github.com/dynoser/HELML/blob/master/docs/README-HELML_ru.md)


# Многослойные массивы

Концепция многослойности даёт возможность привязывать значения к разным слоям массива, а при чтении
запрашиывать некоторый список "слоёв", значения из которых будут объединены в итоговый массив.

Это удобно когда надо получать массивы с незначительными изменениями, которые зависят от каких-либо параметров.

Например, мы создаём файл с описанием настроек программы.
Мы хотим чтобы в режиме отладки программы некоторые настройки заменялись на какие-то другие.
Зададим эти альтернативные варианты настроек для слоя, которй назовём, например, "dbg".
Далее, при извлечении конфигурации, указываем, что хотим извлечь основной слой и слой "dbg".
В результате получим массив, в котором поверх основного слоя будет "наложены" значения из слоя "dbg".

Другой пример.
Допустим, среди настроек программы есть парамер hello со значением "Hello World!".
Мы хотим, чтобы при использовании русского языка это значение изменялось на "Здравствуй мир!".
В концепции многослойности просто добавим это значение к слою, который назовём, например, "ru".
При чтении файла настроек дополнительно будем указывать для чтения слой с именем текущего языка.
Если язык "ru", и мы при чтении запросим дополнительный слой "ru", то мы получим в результате массив,
в котором параметр hello будет иметь значение "Здравствуй мир!".
Потому что поверх исходного слоя наложится слой с именем "ru", в котором значение параметра hello иное.

Объединив приведённые выше примеры мы можем дополнительно запросить слои "ru" и "dbg", чтобы получить
на выходе массив, в котором значения будут изменены в соответствии со слоями "ru" и "dbg".

Мы можем задавать сколько угодно слоёв и связывать с ними какие-то параметры.
Затем, когда мы запросим список любых слоёв, мы получем объединение соответствующих параметров.
Если один и тот же параметр будет задан в нескольких слоях, то мы получим самое последнее значение.
Каждое последующее значение заменяет предыдущее, мы всегда получим последнее значение из всех вариантов.

# Многослойность в языке HELML

Слои HELML-массива можно представлять себе как массивы с одинаковой структурой, но разными значениями.

При запросе любого слоя или комбинации слоёв мы получим в результате одинаковую структуру вложенности массивов.

Массивы считаются не значениями, а структурой, каркасом.

Если мы запросим не существующий слой, то получим пустую структуру массивов (каркас, в котором не будет никаких значений).

Если мы запросим существующие слои, то получим струтуру, в которой будут вписаны значения, соответствующие этим слоям.

Под существующими слоями мы подразумеваем те слои, с которыми связаны какие-либо значения.

## Особенности реализации

I. Слой `0`.
 - Слой `0` является слоем "по умолчанию".
 - Когда многослойность "не используется", на самом деле используется слой `0`.
 - Когда массив описан без указания слоёв, все его элементы привязаны к слою `0`.
 - При чтении массива без указания слоёв, происходит чтение слоя `0`.

II. Имена слоёв
 - Именем слоя может быть либо целое число, либо не-пустая строка.
 - Если имя слоя число, то переход на "следующий слой" увеличит это число на 1.
 - Если имя слоя не-число, то переход на "следующий слой" будет возвратом на слой `0`.

III. Ключ указания слоя
 - Для использования многослойности в HELML используется особый ключ "`-+`".
 - После ключа `-+` можно поставить двоеточие и указать конкретное имя слоя.
 - Если после ключа `-+` не указано имя слоя, то это переход на "следующий слой".
 - Пока мы не используем ключ "`-+`", многослойность никак не проявляется.

IV. Авто-возврат в слой `0`
 - При любом изменении уровня вложенности массива имя текущего слоя сбрасывается в `0`.
 - В частности, при создании нового уровня вложенности, текущий слой станет `0`.
 - А также, при возврате на предыдущий уровень вложенности, текущий слой станет `0`.

V. Значение `[_layers]`
 - Если в описании массива заданы иные слои, кроме `0`, мы получим в результатах дополнительный ключ
`[_layers]`, в котором содержится список всех слоёв, упоминаемых в описании массива.
 - Если в описании массива не упоминаются слои, список [_layers] не будет добавлен результат.

# Примеры

1. Рассмотрим простейший многослойный массив, в котором задаётся только одно значение `A[test]`:
```console
A
 :test: значение в слое 0
 :-+
 :test: Значение в слое 1
 :-+
 :test: Этот же ключ в слое 2
```
В данном примере мы дважды используем ключ "-+" для перехода на "следующий слой".
Поскольку изначально у нас слой 0, то первый переход будет на слой 1, второй на слой 2.
Сделав переход на слой 1, мы задаём значаение для слоя 1.
Далее, делаем переход на слой 2 и задаём значение для слоя 2.

Теперь если мы декодируем этот массив из HELML, то получим следующее:
```json
{
	"A": {
		"test": "значение в слое 0"
	},
	"_layers": [0,1,2]
}
```
Как и ожидалось, мы получили значение `A[test]` из нулевого слоя.
Значения из других слоёв мы не запрашивали, а по умолчанию мы запрашиваем слой 0.

В результате появился ключ [_layer], в содержащий список всех слоёв, упомянутых в массиве.

Если декодировать этот массив из HELML, запросив слой [1], получится следующее:
```json
{
	"A": {
		"test": "Значение в слое 1"
	},
	"_layers": [0,1,2]
}
```

## Пример с выбором языка

```console
    name: Program name
    msg: Press "START"

    -+:ru
    msg: Нажмите "START"

    -+:de
    msg: Drücke "START"

    -+
    hello: Test hello
```

В данном примере декодирование по умолчанию даст такой результат:
```json
{
	"name": "Program name",
	"msg": "Press \"START\"",
	"hello": "Test hello",
	"_layers": [0, "ru", "de"]
}
```
В данном примере обратим внимание на ключ `-+` перед строкой "hello".
Здесь переход на "следующий слой" в вернёт слой `0`, поскольку значение "de" не числовое.
Если этого не сделать, то "hello" будет привязано к слою "de".

Ещё раз напомним, что "текущий слой" устанавливается в '0' в следующих случаях:
 - при любом изменении текущего уровня вложенности
 - при явном указании этого слоя: `"-+:0"`
 - при указании `"-+"` без параметров, в том случае, если текущее имя слоя не числовое.

Важно не забывать возвращать запись на слой `0`, если выше был сделан переход на другой слой.
